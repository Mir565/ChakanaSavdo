<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Creative - Bootstrap 3 Responsive Admin Template">
  <meta name="author" content="GeeksLabs">
  <meta name="keyword" content="Creative, Dashboard, Admin, Template, Theme, Bootstrap, Responsive, Retina, Minimal">
  <link rel="shortcut icon" href="/img/favicon.png">
  <title>Обн.. Продукта</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/bootstrap-theme.css" rel="stylesheet">
  <link href="/css/elegant-icons-style.css" rel="stylesheet" />
  <link href="/css/font-awesome.min.css" rel="stylesheet" />
  <link href="/css/style.css" rel="stylesheet">
  <link href="/css/style-responsive.css" rel="stylesheet" />
</head>
<body >
  <%- include('nav')%>
    <section id="main-content">
      <section class="wrapper">
        <div class="row" id="sa">
          <div class="col-lg-12">
            <h3 class="page-header"><i class="fa fa-table"></i>    Sotuv Bo'limi
            </h3>
           
          </div>
        </div>
        <center> 
       <input type="text" id="customername" class="form-control" placeholder="Xaridor Nomi">
       <br>
       <input type="text" id="curiername" class="form-control" placeholder="Kurier Nomi">
        </center>
        <br>
        <div  id="sabzi">
          <table class="table table-striped table-advance table-hover" id="salom">
            <!-- <div class="clear"></div> -->
        </div>
        </center>
        <center><button style="margin-bottom: 5px;" class="btn btn-primary" onclick="minus()" id="tas">Подтверждение
        </button>
        </center>
        <center>
          <div class="form-check">
          
            <center>
              <b id="nameofMarket" style="display: none;color:black;font-size: 57px;font-family:'Arial Narrow', Arial, sans-serif;;"></b>
            </center>
            <br>
            <b id="nameofCustomer" style="display: none;font-size:30px;font-family:'Arial Narrow', Arial, sans-serif;color:black"></b>
            <b id="telofMarket" style="display: none;font-size:30px;font-family:'Arial Narrow', Arial, sans-serif;color:black"></b>
            <b id="timenow" style="display:none;font-size:30px;font-family:'Arial Narrow', Arial, sans-serif;color:black"></b>
    <b id="yulduz"  style="display: none;color:black;font-size: 40px;font-family:'Arial Narrow', Arial, sans-serif;" ></b>
    <br>
    
          </div>
        </center>
     
        </table>
        <b id="yulduz1" style="display: none;color:black;font-size: 40px;font-family:'Arial Narrow', Arial, sans-serif;" ></b>
        <center>
          <b style="font-size: 45px;font-family:'Arial Narrow', Arial, sans-serif;" id="all"></b>
        </center>
        <center>
          <b style="font-size: 45px;font-family:'Arial Narrow', Arial, sans-serif;" id="skidkani"></b>
        </center>
        <center>
          <b style="font-size: 45px;font-family:'Arial Narrow', Arial, sans-serif;" id="puli"></b>
        </center>
        <b id="yulduz2"  style="display: none;color:black;font-size: 40px;font-family:'Arial Narrow', Arial, sans-serif;" ></b>
        <center>
          <b style="font-size: 25px;font-family:'Arial Narrow', Arial, sans-serif;" id="commentofMarket" style="display: none;color:black"></b>
        </center>
         </div>
        <center>
          <h3 id="debtorofdebt"></h3>

       
          <datalist id="customernames">

          </datalist>


          <h3 style="color: black;" id="tovarsoni"> </h3>
          <h3 style="color: black;" id="tovar"></h3>
          <h3 style="color: black;" id="sotilishi"></h3>
          <h3 style="color: black;" id="foyda"></h3>
        </center>
        <br>
        <br>
        <section id="kill">
          <div class="row">
            <div class="col-lg-12">
              <section class="panel">
                <div class="form-check form-switch">
                </div>

                <table class="table table-advance">
                  <input class="form-control" placeholder="Shtrix Kod" id="searcher" tabindex="0" onkeypress="searchBar(event)"
                    type="text">
                    <br>
                    <input class="form-control" placeholder="Nomi" id="searcher1" tabindex="0" onkeyup="searchText(event)"
                    type="text">


                  <tbody id="mahsulot">

                  </tbody>
                  <center><button class="btn btn-primary" onclick="print()">PRINT</button></center>
                  
                </table>
                
              </section>
             
        </section>
        <h1>
        <center>  Sotuv Jadvali</center>
        </h1>
        <table class="table table-advance">
          <tbody id="mahsulot1">
          
        </table>
        </div>
        </div>

      </section>
    </section>

    <style>
    </style>
    <!--main content end-->
    </section>
 
    <style>
      @media print {
        body {
          margin: 0;
          padding: 0;
        }

        #customername,
        #pagenation,
        #delete,
        #delete1,
        section,
        .row,
        #flexCheckIndeterminate,
        #saqlash,
        #tas,
        #mahsulot,
        aside,
        #sa,
        header,
        #stat1,
        #stat,
        #searcher,
        #flexSwitchCheckChecked,
        #kamqolgan {
          display: none;
        }

        br {
          display: none;
        }

      }
    </style>
    <center>
      <h2 id="xarid"></h2>
    </center>
    <!-- container section end -->
    <!-- javascripts -->
    <script src="/js/jquery.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <!-- nicescroll -->
    <script src="/js/jquery.scrollTo.min.js"></script>
    <script src="/js/jquery.nicescroll.js" type="text/javascript"></script>
    <!--custome script for all page-->
    <script src="/js/scripts.js"></script>
    <script>
           
           function xaridorgen(){
  var uniq = 'id' + (new Date()).getTime();
document.getElementById("customername").value=uniq;
}
xaridorgen()
      var dict = {};
      var dictnames={};
      var telnumber;

      var Mahsulotlar;
    function searchBar(event){
      if (event.key ==="Enter"){
      $.ajax({
            url: `/search/item?barcode=${document.getElementById('searcher').value}`,
            type: "GET",
            cache: false,
            contentType: 'application/json',
            dataType: 'json',
            success: data => {
              console.log(data)
              if (data.barcode!=undefined){
                document.getElementById('searcher').value=""
                createTable([data]);
              }else{
                alert('Topilmadi')
              }
            }
          })
    }
  }
  function searchText(event){
      if (event.key ==="Enter"){
      $.ajax({
            url: `/search/itemText?name=${document.getElementById('searcher1').value}`,
            type: "GET",
            cache: false,
            contentType: 'application/json',
            dataType: 'json',
            success: data => {
              console.log(data)
                createTable(data);
            }
          })
    }
  }
      function createTable(Mahsulotlar, pagename) {
        begin = 0;
        end = Mahsulotlar.length;
          s = `<tr><th>После.. чисел</th>
            <th>Tovar Nomi</th>
            <th>Soni</th>
                      <th>Olingan Narxi</th> 
                        <th> Sotiladigan Narxi</th> 
                        <th>Barkod</th> 
                        <th>Sonini Kiriting</th> 
                        <th>Narxi Kiriting</th> 
                        <th>Qo'shish</th> 
                       </tr>`;
          var table = document.getElementById('mahsulot')

           for (var i = begin; i < end; i++) { 
              if (dict[Mahsulotlar[i].name] == 1) {
                stylex = "#ff2d55";
              }
              else {
                stylex = "#ffffff";
              }
              var xbarkod=Mahsulotlar[i].barcode;
              var xname = Mahsulotlar[i].name;
              var xcountnum = Mahsulotlar[i].pr_count;
              
              var xprice =  Mahsulotlar[i].ISSUM?Mahsulotlar[i].price:Mahsulotlar[i].price*kurs;
            
              var xbuyprice =Mahsulotlar[i].ISSUM?Mahsulotlar[i].sell_price:Mahsulotlar[i].sell_price*kurs;
              var xid = Mahsulotlar[i].product_id;
                s += `<tr   style="font-size:20px;color:black;background-color:${stylex}" id="tr${f}"><td>${i+1}</td><td>${xname}</td><td>${xcountnum}</td> <td >${xprice}</td><td>${xbuyprice}</td> 
                 <td>${xbarkod}</td>
                    
                  <td><input type="number" tabindex=${f * 3 + 3} id="soni${xid}"  class="form-control" /></td>
                  <td><input type="number" tabindex=${f * 3 + 3} id="narxi${xid}"  class="form-control" /></td>  
                      <td id="stat1"> <div class="btn-group"> 
                        <button class="btn btn-success"  id="s${xid}" name="${xcountnum}" tabindex=${f * 3 + 4}   onclick="add(${xid},'${xname}',${xcountnum},${xprice},${xbuyprice},'${xbarkod}')">
                      <i class="icon_plus_alt2"></i></button> </td>
            </div>`
            } 
        table.innerHTML = s;
      }
  


    
  var allitems=<%- JSON.stringify(allitems) %>
  var organs=<%- JSON.stringify(organs)%>

  var kurs=<%- JSON.stringify(kurs)%>

  Mahsulotlar = allitems
  createTable(Mahsulotlar)
          
          createTable(Mahsulotlar, 1);
     
      var jami = 0;
      var idfornews=[]
      var allid=[]
      var newBarkod=[]
      var arrayFoiz=[]
      var arrayName = []
      var arrayCount = []
      var arrayPrice = []
      var arraySell = [];
      var arrayBazaCount = [];
      var arrayBazaNarx = [];
      function createTable1() {
        jami = 0;
        arraySell = []
        xs = `<tr style="font-family:'Arial Narrow', Arial, sans-serif;font-size:23px"> <th>#N</th>
       <th>Nomi</th>
        <th>Soni</th>
        <th>Narxi</th>
        <th>Jami</th>
      <th id="delete">Удалить
</th>
      </tr>`;
        for (i = 0; i < arrayCount.length; i++) {
          xs +=`<tr style="color:black;font-size:20px;font-family:'Arial Narrow', Arial, sans-serif;" ><td>${i + 1}</td><td> <b style="color:black;font-size:25px;font-family:'Arial Narrow', Arial, sans-serif;">${arrayName[i]}</b></td>        
        
          <td ><b style="color:black;font-size:25px;font-family:'Arial Narrow', Arial, sans-serif;" onclick="changedata(s=${i})">${arrayCount[i]}</b></td>
          <td ><b style="color:black;font-size:25px;font-family:'Arial Narrow', Arial, sans-serif;" onclick="changebazanarx(s=${i})">${arrayPrice[i]}</b></td>
          <td ><b style="color:black;font-size:25px;font-family:'Arial Narrow', Arial, sans-serif;" onclick="changedata(s=${i})">${arrayPrice[i]*arrayCount[i]}</b></td>
          <td><button class="btn btn-danger" id="delete1" onclick="addminus(s=${i})">удалить</button></td></tr>
          `
        }
        
        
        document.getElementById('mahsulot1').innerHTML = xs;
      }
      function changedata(index){
        t=prompt("soni")
        if (parseInt(t) && parseInt(t)<=arrayBazaCount[i]){
          arrayCount[index]=parseInt(t);
          createTable1();
        }
        else
        alert("Error!")       
      }
      function changebazanarx(index){
      
        t=prompt("Narxni kiriting")
        if (parseInt(t)&& arrayBazaNarx[i]<t){
          arrayPrice[index]=parseInt(t);
          createTable1();
        }
        else
        alert("Mahsulot zararga sotilyapti yoki boshqa error!")       
      }
      var naqd, plastik, qarz, pulkochrish, kun, summa, telnumber;
      function skidka() {
       return 0;
      }
      function money(){
        naqd = 0;
        plastik = 0;
        qarz = 0;
        pulkochrish = 0;
        summa = calcSumma(arrayPrice)
        naqd = prompt(`Наличные:${summa}`, summa);
        summa -= naqd;
        if (summa > 0)
          plastik = prompt(`Пластик
:${summa}`, summa);
        summa -= plastik;
        if (summa > 0) {
          qarz = prompt(`Долг:${summa}`, summa);
          if (qarz > 0) {
            if (!telnumber)
              telnumber = prompt("Номер телефона", "+998941234567")
            else {
              telnumber = prompt("Номер телефона", telnumber)
            }
          }
        }
        summa -= qarz;
        if (summa > 0)
          pulkochrish = prompt(`Перевод денег:${summa}`, summa);
        summa -= pulkochrish;
        if (summa > 0) {
          return 0;
        }
      }
      function cliked(i) {
        x = prompt("Остаток", arrayCount[i])
        if (!parseFloat(x)) {
          alert("Пожалуйста, введите номер!")
          return 0;
        }
        if (parseFloat(arrayBazaCount[i]) < parseFloat(x)) {
          alert("В базе не так уж много товаров!")
          return 0;
        }
        if (parseFloat(x) < 0) {
          alert("Была сделана попытка ввести отрицательное число! Если это повторится, администратору будет отправлена ​​жалоба на продавца! \n Примечание: Попытка обмануть систему")
          return 0;
        }
        arrayCount[i] = x;
        createTable1();
      }
      function clikedone(i){
        t = prompt("Цена", arrayPrice[i])
        if (!parseFloat(t)) {
          alert("Пожалуйста, введите номер!")
          return 0;
        }
        if (parseFloat(arrayBazaNarx[i]) >= parseFloat(t)) {
          alert("Вы пытаетесь продать в убыток! Проверьте это!")
          return 0;
        }
        arrayPrice[i] = t;
        createTable1();
      }
     
      function add(xid,xname,xcountnum,xprice,xbuyprice,xbarkod){
        count=parseFloat(document.getElementById('soni'+xid).value);
        narxi=parseFloat(document.getElementById('narxi'+xid).value);
        if (xprice>=narxi){
          alert("Mahsulotni zararga sotib bo'lmaydi")
          return 0;
        }
        if (xcountnum<count){
                  alert ("bazada buncha mahsulot mavjud emas!")
                  return 0;
                }
        document.getElementById("searcher").value="";
        document.getElementById('searcher1').value="";
        document.getElementById("searcher").focus();
        document.getElementById("searcher").focus();
          flag = 0;
          for (let i = 0; i < arrayName.length; i++) {
            if (arrayName[i] === xname) {
                if (arrayCount[i]+count>xcountnum){
                  alert ("bazada buncha mahsulot mavjud emas!")
                  return 0;
                } 
                arrayPrice[i]=narxi;
                arrayCount[i] = arrayCount[i] + count;
                createTable1();
                createTable([])
                flag = 1; 
            }
          }
          if (flag == 0) {
        arrayCount.push(count);
        arrayName.push(xname);
        arrayPrice.push(narxi);
        arrayBazaCount.push(xcountnum);
        arrayBazaNarx.push(xprice);
        allid.push(xid);
        dict[xname] = 1;
        createTable([])
        createTable1();
          }
      }
      function print(){
        window.open(`/print?arrayname=${arrayName}&arraycount=${arrayCount}&arrayprice=${arrayPrice}&cusname=salim`);
      }
      function addminus(s) {
        dict[arrayName[s]] = 0;
        arrayCount.splice(s, 1);
        arrayName.splice(s, 1);
        arrayPrice.splice(s, 1);
        arrayBazaCount.splice(s, 1);
        arrayBazaNarx.splice(s, 1);
        allid.splice(s,1);
        createTable1();
      }
      function CheckNull(t) {
        if (t === null) {
          return 0;
        }
        else {
          return t;
        }
      }
      function calcSumma(arrayPrice){
        let summa=0;
        for(let i=0;i<arrayPrice.length;i++){
summa+=arrayPrice[i];
        }
      return summa
      }

      function minus() {
        var organid=1
        var customername=document.getElementById('customername').value;
        var curiername=document.getElementById('curiername').value;
        if (arrayCount.length == 0) {
          alert("Продажа не состоялась!")
          return 0;
        }
        money();
        if (summa != 0) {
          alert("Вы сделали ошибку при входе!")
          return 0;
        }
        naqd = CheckNull(naqd);
        plastik = CheckNull(plastik)
        pulkochrish = CheckNull(pulkochrish)
        qarz = CheckNull(qarz);
        alert(`Наличные:${naqd}\n Пластик
:${plastik}\n Перевод денег
:${pulkochrish}\n Долг:${qarz}`)
        var r = confirm('Подтверждать?')
        if (r == true) {
                   $.ajax({
            url: '/add/sell',
            type: "POST",
            cache: false,
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify({telnumber:telnumber,customername:customername,curiername:curiername, summa: summa, cash: parseFloat(naqd), card: parseFloat(plastik), transfer: parseFloat(pulkochrish), debt: parseFloat(qarz), minusName: arrayName, minusCount: arrayCount,  organid: organid, minusPayment: arrayPrice, skidka: skidka(), bazanarx:arrayBazaNarx,allid:allid}),
            success: data => {
            }
          })
          location.reload();
        }
      }
    </script>
</body>
</html>